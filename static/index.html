<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My Finance Dash</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 40px; background: #f0f2f5; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        
        /* Modal å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; z-index: 1; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 300px; text-align: center; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; background: #007bff; color: white; }
        .btn-cancel { background: #6c757d; margin-top: 10px; }
        input[type="password"] { width: 80%; padding: 8px; margin: 15px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å€‹äººè³‡ç”¢ç´€éŒ„ç³»çµ±</h1>
        
        <div class="card">
            <h3>åŒ¯å…¥å°å¸³å–® (PDF)</h3>
            <input type="file" id="pdfFile" accept=".pdf">
            <p id="statusMsg" style="color: blue;"></p>
        </div>

        <div id="pwdModal" class="modal">
            <div class="modal-content">
                <h3>è¼¸å…¥ PDF å¯†ç¢¼</h3>
                <p style="font-size: 0.8em; color: #666;">æ­¤å¯†ç¢¼åƒ…ä¾›æœ¬æ¬¡è§£æä½¿ç”¨ï¼Œç³»çµ±ä¸æœƒå„²å­˜</p>
                <input type="password" id="pdfPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                <br>
                <button class="btn" onclick="submitUpload()">ç¢ºèªä¸Šå‚³</button>
                <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="card">
            <h3>æœ€è¿‘äº¤æ˜“æ˜ç´°</h3>
            <table id="txTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ‘˜è¦</th>
                        <th>é‡‘é¡</th>
                        <th>åºè™Ÿ/è½‰å…¥å¸³è™Ÿ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const pdfFileInput = document.getElementById('pdfFile');
        const pwdModal = document.getElementById('pwdModal');
        const pdfPwdInput = document.getElementById('pdfPwd');

        // 1. ç•¶ä½¿ç”¨è€…é¸å¥½æª”æ¡ˆï¼Œè·³å‡ºå¯†ç¢¼æ¡†
        pdfFileInput.onchange = () => {
            if (pdfFileInput.files.length > 0) {
                pwdModal.style.display = 'block';
                pdfPwdInput.value = ''; // ç¢ºä¿æ¯æ¬¡æ‰“é–‹éƒ½æ˜¯ç©ºçš„
                pdfPwdInput.focus();    // è‡ªå‹•èšç„¦ï¼Œæ–¹ä¾¿ç›´æ¥è¼¸å…¥
            }
        };

        // 2. æ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æ´ Enter éµæäº¤
        pdfPwdInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­è¡Œç‚º
                submitUpload();         // å‘¼å«ä¸Šå‚³å‡½æ•¸
            }
            // é¡å¤–å°å„ªåŒ–ï¼šæŒ‰ Esc éµå¯ä»¥é—œé–‰å½ˆçª—
            if (event.key === "Escape") {
                closeModal();
            }
        });

        function closeModal() {
            pwdModal.style.display = 'none';
            pdfPwdInput.value = ''; // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
            pdfFileInput.value = ''; // é‡ç½®æª”æ¡ˆé¸å–
        }

        async function submitUpload() {
            const file = pdfFileInput.files[0];
            const password = pdfPwdInput.value;

            if (!password) {
                alert("è«‹è¼¸å…¥å¯†ç¢¼");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('password', password);
            
            closeModal(); // é—œé–‰å½ˆçª—ä¸¦æ¸…ç©ºå¯†ç¢¼
            document.getElementById('statusMsg').innerText = "æ­£åœ¨å®‰å…¨è§£æä¸­...";

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                document.getElementById('statusMsg').innerText = result.message;
                fetchTransactions(); // åˆ·æ–°åˆ—è¡¨
            } catch (err) {
                document.getElementById('statusMsg').innerText = "é€£ç·šéŒ¯èª¤";
            }
        }

        async function fetchTransactions() {
            const res = await fetch('/api/transactions');
            const data = await res.json();
            const tbody = document.querySelector('#txTable tbody');
            tbody.innerHTML = data.map(tx => `
                <tr>
                    <td>${tx.trans_date} ${tx.trans_time}</td>
                    <td><b>${tx.summary}</b></td>
                    <td style="color: ${tx.amount < 0 ? 'red' : 'green'}">${tx.amount.toLocaleString()}</td>
                    <td style="font-size: 0.8em; color: #666;">${tx.ref_no}</td>
                </tr>
            `).join('');
        }

        fetchTransactions();
    </script>
</body>
</html>