<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>My Finance Dash</title>
    <link rel="stylesheet" href="/static/style.css?v=13">
</head>
<body>
    <div class="container">
        <h1>
            📊 個人資產紀錄系統
            <button class="btn btn-sm" onclick="openAccModal()" style="width: auto; margin-left: auto; background-color: #64748b;">
                ⚙️ 帳戶管理
            </button>
        </h1>

        <div id="account-list" class="account-scroll-container">
            </div>

        <div class="card">
            <h3>匯入交易 (PDF 對帳單 或 截圖)</h3>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; color: var(--text-muted); font-size: 0.9rem;">選擇來源銀行：</label>
                <select id="uploadBankSelect" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
                    <option value="700">中華郵政 (700)</option>
                    <option value="050">台灣企銀 (050)</option>
                </select>
            </div>
            <input type="file" id="fileInput" accept=".pdf,image/*" multiple>
            <p id="statusMsg" style="color: blue; margin-top: 10px;"></p>
        </div>

        <div class="card">
            <div class="card-header-row">
                <h3>交易紀錄</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="switchView('details')" id="btnViewDetails">明細</button>
                    <button class="toggle-btn" onclick="switchView('stats')" id="btnViewStats">統計</button>
                </div>
            </div>

            <div class="month-filter-bar">
                <button class="btn-icon" onclick="changeMonth(-1)" title="上個月">◀</button>
                <input type="month" id="monthPicker" onchange="handleMonthChange()">
                <button class="btn-icon" onclick="changeMonth(1)" title="下個月">▶</button>
                <button class="btn-text" onclick="resetToCurrentMonth()">回本月</button>
            </div>

            <div id="view-details">
                <table id="txTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>摘要</th>
                            <th>金額</th>
                            <th>序號/轉入帳號</th>
                            <th style="width: 100px;">操作</th> 
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="noDataMsg" style="display:none; text-align:center; padding:20px; color:#888;">
                    本月尚無交易紀錄
                </div>
            </div>

            <div id="view-stats" style="display: none;">
                <div class="stats-section">
                    <h4 class="amount-pos">💰 收入統計 <span id="stats-income-total" class="stats-total"></span></h4>
                    <table class="stats-table" id="statsTableIncome">
                        <thead><tr><th>摘要項目</th><th>筆數</th><th style="text-align:right">總金額</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="stats-section" style="margin-top: 20px;">
                    <h4 class="amount-neg">💸 支出統計 <span id="stats-expense-total" class="stats-total"></span></h4>
                    <table class="stats-table" id="statsTableExpense">
                        <thead><tr><th>摘要項目</th><th>筆數</th><th style="text-align:right">總金額</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="pwdModal" class="modal">
        <div class="modal-content">
            <h3>輸入 PDF 密碼</h3>
            <input type="password" id="pdfPwd" placeholder="請輸入密碼">
            <br>
            <button id="btnSubmit" class="btn">確認上傳</button>
            <button id="btnCancel" class="btn btn-cancel">取消</button>
        </div>
    </div>

    <div id="ocrBatchModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; display: flex; flex-direction: column;">
            <h3>📸 圖片辨識結果校對</h3>
            
            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
                <label style="font-size: 0.85rem; color: #64748b; font-weight: bold;">匯入目標帳戶</label>
                <select id="ocrBatchAccount" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #cbd5e1;">
                    <option value="">-- 請選擇歸戶帳戶 --</option>
                </select>
            </div>

            <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 10px;">
                請逐筆核對下方資料，可直接修改內容或刪除錯誤項目。
            </p>

            <div id="ocrBatchList" style="flex: 1; overflow-y: auto; padding: 5px; margin-bottom: 15px;">
                </div>

            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button id="btnBatchSave" class="btn" onclick="saveOcrBatch()">確認全部匯入</button>
                <button class="btn btn-cancel" onclick="closeOcrBatchModal()">取消</button>
            </div>
        </div>
    </div>

    <div id="ocrModal" class="modal">
        <div class="modal-content">
            <h3>🔍 辨識結果校對</h3>
            <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 20px;">
                請確認圖片辨識結果，手動修正錯誤項
            </p>
            <div class="ocr-form">
                <div class="form-item">
                    <label>帳號末 5 碼 (系統自動辨識)</label>
                    <input type="text" id="ocrAccount" placeholder="例: 12345" maxlength="5">
                </div>
                <div class="form-item">
                    <label>交易日期</label>
                    <input type="text" id="ocrDate">
                </div>
                <div class="form-item">
                    <label>交易時間</label>
                    <input type="text" id="ocrTime">
                </div>
                <div class="form-item">
                    <label>交易摘要</label>
                    <input type="text" id="ocrSummary">
                </div>
                <div class="form-item">
                    <label>交易金額 (支出請輸入負值)</label>
                    <input type="number" id="ocrAmount" step="1">
                </div>
                <div class="form-item">
                    <label>交易序號</label>
                    <input type="text" id="ocrRef">
                </div>
            </div>

            <p id="ocrErrorMsg" style="color: var(--danger-color); font-weight: bold; margin-top: 15px; min-height: 1.5em;"></p>
            
            <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px;">
                <button id="btnOcrSave" class="btn">確認存入資料庫</button>
                <button id="btnOcrCancel" class="btn btn-cancel">取消</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>✏️ 編輯交易</h3>

            <div id="editDuplicateAlert" style="display: none; background: #fef2f2; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem;">
                ⚠️ 此交易資料已存在於資料庫中，請檢查。
            </div>

            <input type="hidden" id="editTxId">
            
            <input type="hidden" id="editId">
            <input type="hidden" id="editAccountId"> <label>日期</label>
            <input type="date" id="editDate" class="inp-block">
            
            <label>時間</label>
            <input type="time" id="editTime" step="1" class="inp-block">
            
            <label>摘要</label>
            <input type="text" id="editSummary" class="inp-block">
            
            <label>金額</label>
            <input type="number" id="editAmount" class="inp-block">
            
            <label>序號/備註</label>
            <input type="text" id="editRef" class="inp-block">
            
            <div class="modal-actions">
                <button class="btn" onclick="submitEdit()" id="btnSaveEdit">儲存</button>
                <button class="btn btn-cancel" onclick="closeEditModal()">取消</button>
            </div>
        </div>
    </div>

    <div id="accModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>⚙️ 帳戶管理</h3>
            
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table id="accTable">
                    <thead>
                        <tr>
                            <th>暱稱 (ID)</th>
                            <th>帳號末5碼</th>
                            <th>餘額</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            
            <h4 style="text-align: left; margin-bottom: 10px; color: var(--text-muted);">➕ 新增 / 編輯帳戶</h4>
            <input type="hidden" id="accEditId">
            <div class="ocr-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-item">
                    <label>帳戶暱稱 (唯一識別)</label>
                    <input type="text" id="accName" placeholder="例: 生活費帳戶">
                </div>
                <div class="form-item">
                    <label>銀行代碼 (必填)</label>
                    <input type="text" id="accBankCode" placeholder="例: 700">
                </div>
                <div class="form-item" style="grid-column: span 2;">
                    <label>帳號末 5 碼 (僅存5碼)</label>
                    <input type="text" id="accNumber" maxlength="5" placeholder="例: 12345">
                </div>
                <div class="form-item" style="grid-column: span 2;">
                    <label>初始餘額</label>
                    <input type="number" id="accInitBalance" value="0">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="saveAccount()">儲存設定</button>
                <button class="btn btn-cancel" onclick="closeAccModal()">關閉</button>
            </div>
        </div>
    </div>

    <div id="pdfConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>📂 確認 PDF 匯入資訊</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px;">
                請確認歸戶目標，避免資料分散
            </p>

            <div class="ocr-form">
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 0.85rem; color: #64748b;">PDF 偵測帳號</div>
                    <div id="pdfDetectedAcc" style="font-weight: bold; font-size: 1.2rem; color: #2563eb;">---</div>
                    <div id="pdfTxCount" style="font-size: 0.85rem; color: #64748b; margin-top: 5px;">共 0 筆交易</div>
                </div>

                <div class="form-item">
                    <label>請選擇匯入目標帳戶 (必選)</label>
                    <select id="pdfTargetAccount" style="padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); width: 100%; font-size: 1rem;">
                        <option value="">-- 請選擇 --</option>
                        </select>
                </div>
            </div>

            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 10px;">
                <button id="btnPdfSave" class="btn" onclick="savePdfBatch()">確認匯入</button>
                <button class="btn btn-cancel" onclick="closePdfConfirmModal()">取消</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js?v=25"></script>
</body>
</html>